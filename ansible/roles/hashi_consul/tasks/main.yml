- name: check archive stat
  stat:
    path: "{{consul_download_dir}}/{{consul_archive}}"
  register: consul_archive_stat

- name: download consul
  get_url:
    url: "{{consul_download}}"
    dest: "{{consul_download_dir}}"
  register: consul_was_downloaded
  when: consul_archive_stat.stat.exists == False

- name: create consul group
  group:
    name: "{{consul_group}}"
    state: present
    system: yes
  register: consul_group_created

- name: create consul user
  user:
    home: "{{consul_home}}"
    name: "{{consul_user}}"
    group: "{{consul_group}}"
    system: yes
  when: consul_group_created|changed

- name: create consul dirs
  file:
    path: "{{item}}"
    state: directory
    owner: "{{consul_user}}"
    group: "{{consul_group}}"
    mode: 0755
  with_items:
    - "{{ consul_home }}"
    - "{{ consul_home }}/bin"
    - "{{ consul_home }}/cert"
    - "{{ consul_data_dir }}"
    - "{{ consul_config_dir }}"

- name: create consul log directory
  file:
    path: "{{consul_log_file|dirname}}"
    state: directory

- name: touch consul log file
  file:
    state: touch
    path: "{{consul_log_file}}"
    owner: "{{consul_user}}"
    group: "{{consul_group}}"
  changed_when: false

- name: unarchive consul zip
  unarchive:
    src: "{{consul_download_dir}}/{{consul_archive}}"
    dest: "{{consul_home}}/bin"
  when: consul_was_downloaded|changed

- name: set ownership
  file:
    state: directory
    path: "{{consul_home}}"
    owner: "{{consul_user}}"
    group: "{{consul_group}}"
    recurse: yes
  when: consul_was_downloaded|changed

- name: create consul upstart script
  template:
    src: etc/init/consul
    dest: /etc/init/consul
    owner: "{{consul_user}}"
    group: "{{consul_group}}"
  notify:
    - restart consul

- name: consul config file
  template:
    src: etc/consul.conf
    dest: "{{consul_config_file}}"
    owner: "{{consul_user}}"
    group: "{{consul_group}}"
